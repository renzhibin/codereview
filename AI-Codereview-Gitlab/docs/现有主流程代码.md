# ä»£ç è¯„å®¡æœåŠ¡ä¸»æµç¨‹è¿˜åŸ

æ ¹æ®ç”Ÿäº§ç¯å¢ƒä»£ç è¿˜åŸçš„ä¸»æµç¨‹é€»è¾‘

## ä¸€ã€æ•´ä½“æ¶æ„

```
Webhookè§¦å‘ â†’ code_review() â†’ å¤šAgentå¹¶è¡Œè¯„å®¡ â†’ merge_agent_results() â†’ è¾“å‡ºåˆ°GitLab
```

## äºŒã€æ ¸å¿ƒæµç¨‹ä»£ç 

### 1. å…¥å£å‡½æ•°ï¼š`code_review()`

```python
def code_review(handler: MergeRequestHandler, is_add_note=None, is_send_msg=None):
    """
    MRä»£ç è¯„å®¡ä¸»å…¥å£
    :param handler: MergeRequestHandler
    :param is_add_note: æ˜¯å¦æ·»åŠ è¯„å®¡å¤‡æ³¨åˆ°GitLab
    :param is_send_msg: æ˜¯å¦å‘é€æ¶ˆæ¯é€šçŸ¥
    """
    
    # 1. è·å–åŸºæœ¬ä¿¡æ¯
    commits = handler.get_merge_request_commits()
    if not commits:
        _skip_task(task, error_info: "æœªè·å–åˆ°commitä¿¡æ¯", handler, is_add_note)
        return
    
    # 2. æ£€æŸ¥å¹¶è¿‡æ»¤changesï¼ˆåªè¯„å®¡å…³æ³¨çš„æ–‡ä»¶ç±»å‹ï¼‰
    cr_changes = filter_and_handle_changes(changes)
    if not cr_changes:
        _skip_task(task, error_info: "æœªæ£€æµ‹åˆ°éœ€è¦REVIEWçš„ä»£ç ", handler, is_add_note)
        return
    
    # 3. æ ¸å¿ƒè¯„å®¡æµç¨‹
    agent_results_list, merge_results, error_info = handle_mr_code(
        handler, cr_changes, commits, formatted_changes
    )
    
    # 4. ç”ŸæˆGitLabè¯„å®¡å¤‡æ³¨
    if is_add_note and handler.action != 'test':
        notes = _build_gitlab_notes(agent_results_list, merge_results)
        handler.add_merge_request_notes(''.join(notes))
    else:
        logger.info(f"Merge Request Hook event, action={handler.action}, ä¸è¿›è¡Œè¯„å®¡ï¼Œåªæ›´æ–°ä¿¡æ¯ã€‚*")
        update_statistics_rating_merge_status(handler.webhook_data)
    
    # 5. é”™è¯¯å¤„ç†å’Œä»»åŠ¡è®°å½•
    if error_info:
        fail_task_info(task.task_id, error_info)
    else:
        success_task_info(task.task_id)
```

### 2. æ ¸å¿ƒå¤„ç†ï¼š`handle_mr_code()`

```python
def handle_mr_code(handler: MergeRequestHandler, original_changes=None, 
                   commits=None, formatted_changes:list=None):
    """
    å¤„ç†MRä»£ç çš„æ ¸å¿ƒé€»è¾‘
    :return: agent_results_list, merge_results, error_info
    """
    
    # 1. åˆå§‹åŒ–
    small_client = CodeReviewer(handler.client)
    start_time = time.time()
    
    # 2. ä»£ç åˆ†æ‰¹å¤„ç†
    cr_changes_list = split_changes(original_changes, int(os.getenv('CONTENT_MAX_LENGTH', 5000)))
    
    commits_text = ';'.join([commit['title'] for commit in commits])
    agent_results_list = []
    
    # æ˜¯å¦å¯ç”¨æ€è€ƒé“¾ï¼ˆå¤šAgentæ¨¡å¼ï¼‰
    include_thought_chain = False
    error_info = ""
    batch_num = len(cr_changes_list)
    
    if batch_num > 1:
        include_thought_chain = False  # æ‰¹æ¬¡å¤šæ—¶ä¸å¯ç”¨æ€è€ƒ
    
    # 3. éå†æ¯ä¸ªæ‰¹æ¬¡çš„ä»£ç 
    for i, cr_changes in enumerate(cr_changes_list[:max_batch]):
        agent_results = {}
        ast_content = None
        need_recheck = False
        agent_type = ""
        batch_id = str(i+1)
        
        logger.info(f"å¼€å§‹åˆ†ç‰‡è¯„å®¡å¤„ç†, å…± {batch_num} ä¸ªåˆ†ç‰‡, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡")
        
        # 4. éå†æ¯ç§Agentç±»å‹ï¼ˆgeneral, securityç­‰ï¼‰
        for agent_type in agent_types:
            
            # å¦‚æœéœ€è¦ASTä¸Šä¸‹æ–‡ï¼ˆå‰æ¬¡è¯„å®¡è¦æ±‚ï¼‰
            if ast_content is None and os.getenv('AGENT_AST_' + agent_type.upper(), 'false').lower() == 'true':
                # è°ƒç”¨è·å–ASTä¸Šä¸‹æ–‡
                pass
            
            # 5. è°ƒç”¨LLMè¿›è¡Œè¯„å®¡
            review_result, error_info = get_review_result(
                small_client,
                diffs_text=str(cr_changes), 
                commits_text=commits_text,
                agent_type=agent_type,
                include_thought_chain=include_thought_chain,
                ast_content=ast_content,
                batch_num=batch_num,
                batch_id=batch_id,
                error_info=error_info,
                agent_results=agent_results
            )
            
            # 6. è§£æè¯„å®¡ç»“æœ
            agent_results[agent_type] = parse_review_result(
                review_result=review_result, 
                task=task, 
                agent_type=agent_type, 
                batch_num=batch_num, 
                batch_id=batch_id
            )
            
            # 7. æ£€æŸ¥æ˜¯å¦éœ€è¦recheck
            if not need_recheck:
                need_recheck = agent_results[agent_type].need_recheck
        
        logger.info(f"å®Œæˆåˆ†ç‰‡è¯„å®¡å¤„ç†, å…± {batch_num} ä¸ªåˆ†ç‰‡, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡, Agent results: {str(agent_results)}")
        
        agent_results_list.append(agent_results)
    
    # 8. å¦‚æœéœ€è¦recheckï¼Œè¿›è¡ŒäºŒæ¬¡è¯„å®¡
    if need_recheck:
        # think_client = get_think_client()
        
        # æ„å»ºè¯„å®¡æ‘˜è¦æç¤º
        prompt = "è¯·å¯¹ä»¥ä¸‹å¤šä¸ªåˆ†ç‰‡çš„è¯„å®¡ç»“æœè¿›è¡Œç»¼åˆåˆ†æã€‚\n\n"
        
        for i, agent_results in enumerate(agent_results_list):
            recheck_result = agent_results.get('recheck')
            if recheck_result:
                prompt += f"ç¬¬{i+1}ä¸ªåˆ†ç‰‡çš„è¯„å®¡ç»“æœ: {recheck_result.review_result}\n\n*"
        
        prompt += """è¯·ç»¼åˆæ‰€æœ‰åˆ†ç‰‡çš„è¯„å®¡ç»“æœ, æœ€ç»ˆç»™å‡ºç²¾ç‚¼çš„è¯„å®¡
è¯·ä»¥JSONæ ¼å¼è¿”å›ç»“æœ***"""
        
        try:
            # è°ƒç”¨å¤§æ¨¡å‹è¿›è¡Œæ±‡æ€»è¯„å®¡
            merged_result = think_client.direct_review(prompt)
            score = ""
            logger.info(f"å¤§æ¨¡å‹æ±‡æ€»ç»“æœ: {merged_result}")
            
            if not merged_result:
                logger.warning("åˆå¹¶è¯„å®¡ç»“æœä¸ºç©º")
                return {
                    "status": "1",
                    "result": "åˆå¹¶è¯„å®¡ç»“æœä¸ºç©º, è¯·æ£€æŸ¥å¤§æ¨¡å‹è¿”å›å†…å®¹",
                    "score": ""
                }
            
            try:
                score = rating_parse_util.extract_score_v2(merged_result).score
            except Exception as e:
                logger.warning(f"è§£ææ±‡æ€»ç»“æœå¤±è´¥: {str(e)}")
            
            logger.info(f"æ±‡æ€»ç»“æœ: {merged_result}")
            return {
                "status": "0",
                "result": merged_result,
                "score": score
            }
            
        except Exception as e:
            logger.error(f"åˆå¹¶è¯„å®¡ç»“æœå¤±è´¥: {str(e)}")
            return {
                "status": "1",
                "result": "æ±‡æ€»è¯„å®¡ç»“æœå¤±è´¥, å‚è€ƒè¯„å®¡è¿‡ç¨‹",
                "score": ""
            }
    
    # 9. åˆå¹¶å¤šä¸ªAgentçš„è¯„å®¡ç»“æœ
    merge_results = merge_agent_results(agent_results_list)
    end_time = time.time()
    
    return agent_results_list, merge_results, error_info
```

### 3. LLMè°ƒç”¨ï¼š`get_review_result()`

```python
def get_review_result(client, diffs_text, commits_text, agent_type, 
                     include_thought_chain, ast_content, batch_num, 
                     batch_id, error_info, agent_results=None):
    """
    è°ƒç”¨LLMè¿›è¡Œä»£ç è¯„å®¡
    :param client: LLMå®¢æˆ·ç«¯
    :param diffs_text: diffä»£ç 
    :param commits_text: æäº¤ä¿¡æ¯
    :param agent_type: Agentç±»å‹(general, security, recheckç­‰)
    :param include_thought_chain: æ˜¯å¦åŒ…å«æ€è€ƒé“¾
    :param ast_content: ASTä¸Šä¸‹æ–‡
    :param batch_num: æ€»æ‰¹æ¬¡æ•°
    :param batch_id: å½“å‰æ‰¹æ¬¡ID
    :param error_info: é”™è¯¯ä¿¡æ¯ç´¯ç§¯
    :param agent_results: å…¶ä»–Agentçš„ç»“æœï¼ˆç”¨äºrecheckï¼‰
    :return: review_result, error_info
    """
    try:
        # è°ƒç”¨CodeReviewerè¿›è¡Œè¯„å®¡
        review_result = client.review_code(
            diffs_text=str(diffs_text), 
            commits_text=commits_text,
            agent_type=agent_type,
            include_thought_chain=include_thought_chain, 
            ast_content=ast_content,
            agent_results=agent_results
        )
        
        return review_result, error_info
        
    except Exception as e:
        stack_trace = traceback.format_exc()
        
        # å¤§æ¨¡å‹è¯·æ±‚å¤±è´¥, å…± {batch_num} ä¸ªåˆ†ç‰‡, å½“å‰Agentç±»å‹: {agent_type}, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡
        tmp_error_info = f"\nå¤§æ¨¡å‹è¯·æ±‚å¤±è´¥, å…± {batch_num} ä¸ªåˆ†ç‰‡, å½“å‰Agentç±»å‹: {agent_type}, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡"
        error_info += tmp_error_info
        logger.error(tmp_error_info + stack_trace)
        
        return review_result, error_info
```

### 4. ç»“æœè§£æï¼š`parse_review_result()`

```python
def parse_review_result(review_result, task, agent_type, batch_num, batch_id):
    """
    è§£æLLMè¿”å›çš„è¯„å®¡ç»“æœ
    :param review_result: LLMè¿”å›çš„åŸå§‹æ–‡æœ¬
    :param task: ä»»åŠ¡å¯¹è±¡
    :param agent_type: Agentç±»å‹
    :param batch_num: æ‰¹æ¬¡æ€»æ•°
    :param batch_id: å½“å‰æ‰¹æ¬¡ID
    :return: AgentResultå¯¹è±¡
    """
    
    if not review_result:
        logger.warning(f"reviewç»“æœä¸ºç©º, ç›´æ¥è¿”å›ç¼ºè®¤ç»“æœ, å…± {batch_num} ä¸ªåˆ†ç‰‡, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡")
        return AgentResult(
            review_result=review_result,
            question_list=[],
            question_list_str="",
            overall_score=Score(-1, -1),
            need_recheck=False,
            extract_json=""
        )
    
    # åˆå§‹åŒ–
    question_list = []
    if extract_json:
        # ä»JSONä¸­è§£æé—®é¢˜åˆ—è¡¨
        question_list = Question.parse_rating_questions(
            task_id=task.task_id, 
            rating_info=review_result,
            agent_type=agent_type, 
            batch_id=str(batch_id),
            extract_json=extract_json
        )
        overall_score = rating_parse_util.extract_score_v2(extract_json)
    
    if question_list:
        need_recheck = True
        question_list_str += '\n'.join([str(q) for q in question_list])
    
    logger.info(
        f"æå–jsonæ•°æ®, å…± {batch_num} ä¸ªåˆ†ç‰‡, agent_type: {agent_type}, å½“å‰å¤„ç†ç¬¬ {batch_id} ç‰‡, json: {json.dumps(extract_json, separators=(',', ':'))}"
    )
    
    return AgentResult(
        review_result=review_result, 
        question_list=question_list,
        question_list_str=question_list_str,
        overall_score=overall_score,
        need_recheck=need_recheck,
        extract_json=extract_json
    )
```

### 5. ç»“æœåˆå¹¶ï¼š`merge_agent_results()`

```python
def merge_agent_results(agent_results_list):
    """
    åˆå¹¶å¤šä¸ªAgentçš„è¯„å®¡ç»“æœ
    :param agent_results_list: å¤šä¸ªæ‰¹æ¬¡çš„Agentç»“æœåˆ—è¡¨
    :return: åˆå¹¶åçš„ç»“æœå­—å…¸
    """
    
    # æ”¶é›†æ‰€æœ‰recheckç»“æœ
    recheck_results = []
    
    for agent_results in agent_results_list:
        recheck_result = agent_results.get('recheck')
        if recheck_result:
            recheck_results.append(recheck_result)
    
    if not recheck_results:
        # æƒ…å†µ1: æ²¡æœ‰éœ€è¦å¤æ ¸çš„é—®é¢˜
        return {
            "status": "0",
            "result": "é€šè¿‡é€šè¿‡",
            "score": "10"
        }
    
    if len(recheck_results) == 1:
        # æƒ…å†µ2: åªæœ‰ä¸€ä¸ªå¤æ ¸ç»“æœ
        recheck_result = recheck_results[0]
        if recheck_result and hasattr(recheck_result, 'extract_json'):
            return {
                "status": "0",
                "result": recheck_result.extract_json,
                "score": recheck_result.score
            }
    
    else:
        # æƒ…å†µ3: å¤šä¸ªå¤æ ¸ç»“æœéœ€è¦åˆå¹¶
        return {
            "status": "1",
            "result": "æ±‡æ€»è¯„å®¡ç»“æœæš‚æœªå®Œæˆ, å‚è€ƒè¯„å®¡è¿‡ç¨‹",
            "score": ""
        }
    
    try:
        score = rating_parse_util.extract_score_v2(merged_result).score
    except Exception as e:
        logger.warning(f"è§£ææ±‡æ€»ç»“æœå¤±è´¥: {str(e)}")
    
    logger.info(f"æ±‡æ€»ç»“æœ: {merged_result}")
    return {
        "status": "0",
        "result": merged_result,
        "score": score
    }
```

### 6. ç»“æœæŒä¹…åŒ–ï¼š`save_parse_result()`

```python
def save_parse_result(agent_results_list, cr_changes_list, task, 
                     start_time, end_time, handler, merge_results):
    """
    ä¿å­˜è¯„å®¡ç»“æœåˆ°æ•°æ®åº“å’Œç»Ÿè®¡ç³»ç»Ÿ
    :param agent_results_list: Agentç»“æœåˆ—è¡¨
    :param cr_changes_list: ä»£ç å˜æ›´åˆ—è¡¨
    :param task: ä»»åŠ¡å¯¹è±¡
    :param start_time: å¼€å§‹æ—¶é—´
    :param end_time: ç»“æŸæ—¶é—´
    :param handler: MergeRequestHandler
    :param merge_results: åˆå¹¶åçš„ç»“æœ
    """
    
    total_content = ""
    total_token = 0
    
    for cr_changes in cr_changes_list[:max_batch]:
        content_str = str(cr_changes)
        total_content += content_str
        total_token += token_length(content_str)
    
    content_size = len(total_content)
    token_size = total_token
    send_content_size = content_size
    send_token_size = token_size
    
    # æå–å„ç»´åº¦çš„è¯„å®¡å†…å®¹
    general_contents = []
    general_score = 10
    general_questions = []
    security_contents = []
    security_questions = []
    security_score = 10
    recheck_contents = []
    recheck_questions = None
    recheck_score = 10
    
    # Noneè¡¨ç¤ºæ²¡æœ‰æé—®é¢˜
    for agent_results in agent_results_list:
        general_res = agent_results.get('general')
        security_res = agent_results.get('security')
        recheck_res = agent_results.get('recheck')
        
        if general_res:
            general_contents.append(general_res.review_result)
            general_questions.extend(general_res.question_list)
            general_score = min(general_score, general_res.score)
        
        if security_res:
            security_contents.append(security_res.review_result)
            security_questions.extend(security_res.question_list)
            security_score = min(security_score, security_res.score)
        
        if recheck_res:
            if recheck_res.question_list is not None:
                recheck_questions = []
            recheck_contents.append(recheck_res.review_result)
            
            if recheck_res.question_list is not None:
                recheck_questions.extend(recheck_res.question_list)
            
            if merge_results.get('score'):
                recheck_score = merge_results.get('score')
            else:
                recheck_score = min(recheck_score, recheck_res.score)
    
    # æ„å»ºå®Œæ•´çš„è¯„å®¡å†…å®¹
    merge_content = merge_results.get("result") or ""
    total_score = merge_results.get("score") or "**"
    
    general_score_text, security_score_text, recheck_score_text = (
        total_score, general_score, security_score, recheck_score,
        start_time, end_time,
        ExtendData(handler.client.model_name(), content_size, send_content_size,
                  token_size, send_token_size)
    )
    
    logger.info(f"ä¿å­˜merge ratingç»“æœ, task_id: {task.task_id}")
```

### 7. ç”ŸæˆGitLabå¤‡æ³¨ï¼š`_build_gitlab_notes()`

```python
def _build_gitlab_notes(agent_results_list, merge_results:str=""):
    """
    æ„å»ºGitLabæ³¨é‡Šå†…å®¹, æ¯ç±»agentçš„è¯„å®¡ç»“æœï¼Œå¯æ£€æµ‹åˆ°æœ‰é—®é¢˜
    """
    
    notes = []
    result_value = merge_results.get("result", "")
    merge_score = merge_results.get("score", "**")
    think_content = ""
    post_think = ""
    
    if not result_value:
        logger.error(f"ç©ºçš„æ±‡æ€»è¯„å®¡ç»“æœ")
        result_value = "åˆå¹¶è¯„å®¡ç»“æœä¸ºç©º, è¯·æ£€æŸ¥å¤§æ¨¡å‹è¿”å›å†…å®¹"
    
    if result_value:
        # ä½¿ç”¨æ­£åˆ™æå– <think> å’Œ </think> ä¹‹é—´çš„å†…å®¹
        think_match = re.search(r'<think>(.*?)</think>', result_value, re.DOTALL)
        if think_match:
            think_content, post_think = think_match.groups()
            think_content = think_content.strip()
            post_think = post_think.strip()
        else:
            # å¦‚æœæ²¡æœ‰ <think> æ ‡ç­¾, å…¨éƒ¨ç®—ä½œ post_think
            think_content = ''
            post_think = result_value.strip()
    
    # === å¤„ç†è¯„å®¡ç»“æœ: ç”± post_think ç»„æˆ ===
    notes.append(f"# ğŸ“Š è¯„å®¡ç»“æœ: ")
    
    if merge_score:
        notes.append(f"{merge_score}åˆ†\n\n")
    else:
        notes.append(f"\n\n")
    
    if post_think:
        # ç¡®ä¿æ²¡æœ‰æ­£åˆ™æŠŠä»£ç åˆ é™¤äº†
        has_code_block = re.match(r'^```json\n{post_think}\n```', post_think, re.DOTALL) is not None
        if not has_code_block:
            post_think = post_think.replace("```", "\\'\\'")
        # ç¡®ä¿è¯¥æ ¼å¼åŠ ä¸Š JSON ä»£ç æ ¼å¼åŒ–
        post_think = f"```json\n{post_think}\n```"
        
        stripped_post = post_think.rstrip('\n')
        if not stripped_post.endswith('```'):
            post_think += '\n```'
        
        # ç¿»è¯‘æˆç»Ÿä¸€æ ¼å¼: ç”± post_think ç»„æˆ
        notes.append(f"{post_think}\n\n(~-~ * 80)\n\n")
    else:
        notes.append(f"\n\n")
    
    if think_content:
        notes.append(f"### ğŸš€ è¯¦ç»†è¿‡ç¨‹: \n\n {think_content}\n\n")
    
    notes.append(
        f"## ğŸ¯ æœ¬åœ°ä»£ç è¯„å®¡å…± {len(agent_results_list)} ç»„, å¯æŒ‰æŸ¥çœ‹å„ç»„å†…çš„è¯¦æƒ…\n\n"
    )
    
    # é€ä¸€å¤„ç†å…¶ä»– agent (å¦‚ general, security ç­‰)
    for i, agent_results in enumerate(agent_results_list):
        
        notes.append(f"\n\n## ğŸ“Œ ç¬¬{i+1} ç»„: \n\n")
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ recheck å†…å®¹
        recheck = agent_results.get('recheck', None)
        if recheck:
            content = recheck.review_result
            if content:
                content = content.replace("<think>", "### ğŸ’­æ€è€ƒè¿‡ç¨‹è¯¦ç»†\n\n")
                content = content.replace("</think>", "### æœ€ç»ˆæ•´ä½“æ€è€ƒç»“æŸ\n\n")
                
                notes.append(f"# âœ… å¤æ ¸ç»“æœ: \n\n{content}")
        
        # å†å¤„ç†å…¶ä»– agent (å¦‚ general, security ç­‰)
        for agent, AgentResult in agent_results.items():
            if agent == "recheck":
                continue  # recheck å·²ç»åœ¨å‰å¤„ç†
            
            if AgentResult:
                notes.append(
                    rating_parse_util.build_gitlab_note(
                        AgentResult.review_result, AgentResult.question_list, agent
                    )
                )
    
    notes.append("\n</details>")
    return notes
```

## ä¸‰ã€æ•°æ®ç»“æ„

### AgentResult

```python
@dataclass
class AgentResult:
    """å•ä¸ªAgentçš„è¯„å®¡ç»“æœ"""
    review_result: str          # åŸå§‹è¯„å®¡æ–‡æœ¬
    question_list: List         # é—®é¢˜åˆ—è¡¨
    question_list_str: str      # é—®é¢˜åˆ—è¡¨å­—ç¬¦ä¸²
    overall_score: Score        # æ€»ä½“åˆ†æ•°
    need_recheck: bool          # æ˜¯å¦éœ€è¦å¤æ ¸
    extract_json: str           # æå–çš„JSON
```

## å››ã€å…³é”®ç‰¹æ€§

### 1. å¤šAgentæ¶æ„

- **general**: é€šç”¨ä»£ç è¯„å®¡ï¼ˆåŠŸèƒ½ã€æ€§èƒ½ã€è§„èŒƒï¼‰
- **security**: å®‰å…¨è¯„å®¡ï¼ˆæ¼æ´ã€æƒé™ï¼‰
- **recheck**: å¤æ ¸è¯„å®¡ï¼ˆæ±‡æ€»å‰é¢ç»“æœï¼‰

### 2. åˆ†æ‰¹å¤„ç†

- ä»£ç è¶…é•¿æ—¶è‡ªåŠ¨åˆ†æ‰¹ï¼ˆ`CONTENT_MAX_LENGTH=5000`ï¼‰
- æ¯æ‰¹ç‹¬ç«‹è¯„å®¡ï¼Œæœ€ååˆå¹¶

### 3. æ€è€ƒé“¾æ¨¡å¼

- å•æ‰¹æ¬¡æ—¶å¯ç”¨ `include_thought_chain=True`
- å¤šæ‰¹æ¬¡æ—¶ç¦ç”¨ä»¥èŠ‚çœtoken

### 4. ASTä¸Šä¸‹æ–‡

- å¯é€‰åŠŸèƒ½ï¼Œé€šè¿‡ `AGENT_AST_GENERAL` ç­‰ç¯å¢ƒå˜é‡æ§åˆ¶
- æä¾›å®Œæ•´ä»£ç ä¸Šä¸‹æ–‡è¾…åŠ©è¯„å®¡

### 5. äºŒæ¬¡è¯„å®¡ï¼ˆrecheckï¼‰

- å½“è¯„å®¡å‘ç°é—®é¢˜æ—¶ï¼Œè§¦å‘å¤§æ¨¡å‹æ±‡æ€»
- ä½¿ç”¨ `think_client` è¿›è¡Œæ·±åº¦åˆ†æ

## äº”ã€æµç¨‹å›¾

```mermaid
flowchart TD
    Start[Webhookè§¦å‘] --> GetCommits[è·å–commits]
    GetCommits --> FilterChanges[è¿‡æ»¤changes]
    FilterChanges --> SplitBatches[åˆ†æ‰¹å¤„ç†]
    
    SplitBatches --> LoopBatches{éå†æ‰¹æ¬¡}
    LoopBatches --> LoopAgents{éå†Agentç±»å‹}
    
    LoopAgents --> CallLLM[è°ƒç”¨LLMè¯„å®¡]
    CallLLM --> ParseResult[è§£æç»“æœ]
    ParseResult --> CheckRecheck{éœ€è¦recheck?}
    
    CheckRecheck -->|æ˜¯| SetFlag[æ ‡è®°need_recheck]
    CheckRecheck -->|å¦| NextAgent
    SetFlag --> NextAgent[ä¸‹ä¸€ä¸ªAgent]
    
    NextAgent --> LoopAgents
    LoopAgents -->|å®Œæˆ| NextBatch[ä¸‹ä¸€æ‰¹æ¬¡]
    NextBatch --> LoopBatches
    
    LoopBatches -->|å®Œæˆ| CheckNeedRecheck{æœ‰recheckæ ‡è®°?}
    CheckNeedRecheck -->|æ˜¯| ThinkClient[è°ƒç”¨think_clientæ±‡æ€»]
    CheckNeedRecheck -->|å¦| MergeResults[åˆå¹¶ç»“æœ]
    
    ThinkClient --> FinalResult[ç”Ÿæˆæœ€ç»ˆç»“æœ]
    MergeResults --> FinalResult
    
    FinalResult --> BuildNotes[æ„å»ºGitLabå¤‡æ³¨]
    BuildNotes --> SaveDB[ä¿å­˜åˆ°æ•°æ®åº“]
    SaveDB --> PostToGitLab[å‘å¸ƒåˆ°GitLab]
    PostToGitLab --> End[å®Œæˆ]
```

## å…­ã€ç¯å¢ƒå˜é‡é…ç½®

```bash
# å†…å®¹é•¿åº¦é™åˆ¶
CONTENT_MAX_LENGTH=5000

# Agentç±»å‹
AGENT_TYPES=general,security

# ASTä¸Šä¸‹æ–‡å¼€å…³
AGENT_AST_GENERAL=false
AGENT_AST_SECURITY=true

# æ‰¹æ¬¡é™åˆ¶
MAX_BATCH=3

# æ˜¯å¦æ·»åŠ è¯„å®¡å¤‡æ³¨
NOTE_NEED_ADD=true

# æ˜¯å¦å‘é€æ¶ˆæ¯é€šçŸ¥
MSG_NEED_SEND=false
```

## ä¸ƒã€ä¸æµ‹è¯•æ¡†æ¶çš„å¯¹æ¥ç‚¹

### å…³é”®æ–¹æ³•å¤ç”¨

```python
# æµ‹è¯•æ—¶ç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³•
review_result = client.review_code(
    diffs_text=diff_from_testcase,  # ä»æµ‹è¯•ç”¨ä¾‹è¯»å–
    commits_text="æµ‹è¯•ç”¨ä¾‹",
    agent_type="general",
    include_thought_chain=False,
    ast_content=None,
    agent_results=None
)
```

### è¾“å…¥æ ¼å¼

- **diffs_text**: Git diffæ ¼å¼çš„å­—ç¬¦ä¸²
- **commits_text**: æäº¤ä¿¡æ¯ï¼ˆæµ‹è¯•æ—¶å¯ç”¨å›ºå®šå€¼ï¼‰
- **agent_type**: general/security/recheck

### è¾“å‡ºæ ¼å¼

- è¿”å›JSONå­—ç¬¦ä¸²ï¼ŒåŒ…å«ï¼š
  - `æ€»åˆ†`
  - `é—®é¢˜åˆ—è¡¨`
  - `å„è¯„å®¡é¡¹æ‰£åˆ†æ˜ç»†`

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-12-30
**åŸºäºç”Ÿäº§ä»£ç ç‰ˆæœ¬**: merge_service.py

