# 🔗 方法调用链分析器 - 项目说明

## ✅ 已完成

我已经成功创建了一个**完整的方法调用链分析器**，用于分析Java项目中方法之间的调用关系。

## 📦 新增文件

```
javaparsedemo/
├── src/main/java/com/security/analyzer/
│   ├── MethodCallChainAnalyzer.java    # 交互式调用链分析器（主程序）
│   └── MethodCallChainDemo.java        # 演示版本（自动分析示例）
├── run-callchain.sh                     # 快速启动脚本
├── CALLCHAIN_README.md                  # 功能简介
├── CALLCHAIN_USAGE.md                   # 详细使用指南
└── 方法调用链分析器说明.md           # 本文档
```

## 🎯 核心功能

### 1. 上游分析 ⬆️
**找出谁调用了某个方法（包括间接调用）**

```
示例：查询 save 方法
结果：
  → createOrder (直接调用)
  → updateOrder (直接调用)  
  → batchImport (间接调用：通过createOrder)
```

### 2. 下游分析 ⬇️
**找出某个方法调用了哪些方法（递归穿透）**

```
示例：查询 createOrder 方法
结果：
  → validate (直接)
  → save (直接)
  → findById (间接：通过validate)
  → persist (间接：通过save)
```

### 3. 完整调用链 🔄
同时显示上游和下游，全面了解方法在项目中的位置。

### 4. 递归穿透 🔍
自动递归查找，**包括所有间接调用关系**，最多追踪10层深度。

## 🚀 快速使用

### 方式1: 使用脚本（最简单）

```bash
cd javaparsedemo
./run-callchain.sh
```

### 方式2: Maven命令

```bash
# Demo版 - 自动分析几个关键方法
mvn exec:java -Dexec.mainClass="com.security.analyzer.MethodCallChainDemo"

# 交互式 - 查询任意方法
mvn exec:java -Dexec.mainClass="com.security.analyzer.MethodCallChainAnalyzer"
```

## 📊 实际输出示例

```
=== 方法调用链分析器 - Demo ===

正在分析项目: ../springboot-vuln-demo/src/main/java

找到 8 个Java文件
步骤1: 收集方法定义...
✅ 收集到 42 个方法
步骤2: 分析调用关系...
✅ 构建调用图完成

=== 统计信息 ===
总方法数: 42
有调用关系的方法: 15
被调用的方法: 20
调用方法最多的: DataInitializer.init (调用8个方法)
被调用最多的: OrderRepository.save (被3个方法调用)

================================================================================
🔍 分析方法: OrderController.getOrderById
📍 位置: OrderController.java:22
================================================================================

⬆️  上游调用链（谁调用了它）: 0 个方法
--------------------------------------------------------------------------------
  (无上游调用者 - 可能是入口方法或未被调用)

⬇️  下游调用链（它调用了谁）: 2 个方法
--------------------------------------------------------------------------------
  1. OrderRepository.findById
     └─ OrderRepository.java:8
  2. Optional.orElseThrow
     └─ (外部方法)

📊 调用深度统计:
  最大上游深度: 0
  最大下游深度: 1
```

## 💡 实际应用场景

### 场景1: 追踪IDOR漏洞影响

```bash
# 1. SecurityAnalyzer发现getOrderById有IDOR漏洞
# 2. 使用调用链分析器查询getOrderById
# 3. 查看上游调用者，确定影响范围
# 4. 在所有调用点添加授权检查
```

### 场景2: 代码重构准备

```bash
# 1. 确定要重构的方法
# 2. 查询上游调用者（需要更新的地方）
# 3. 查询下游被调用方法（可能受影响）
# 4. 评估重构风险和工作量
```

### 场景3: 理解业务流程

```bash
# 1. 从Controller的入口方法开始
# 2. 查看完整调用链
# 3. 了解整个业务流程
# 4. 绘制流程图或编写文档
```

### 场景4: 数据流追踪

```bash
# 1. 分析数据处理方法
# 2. 上游：数据从哪里来
# 3. 下游：数据到哪里去
# 4. 完整了解数据流向
```

## 🔧 技术实现

### 核心算法

```
1. 两遍扫描
   第一遍：收集所有方法定义 (类名.方法名 -> MethodInfo)
   第二遍：分析方法调用关系 (构建调用图)

2. 构建双向图
   callGraph: 正向图 (A调用B)
   reverseCallGraph: 反向图 (B被A调用)

3. 递归查询
   findUpstream: 递归查找所有上游调用者
   findDownstream: 递归查找所有下游被调用方法

4. 深度限制
   最大递归深度10层，防止无限循环
```

### 方法解析

```java
// 解析方法调用表达式
orderRepository.findById(id)  -> OrderRepository.findById ✓
save(order)                   -> CurrentClass.save ✓
external.method()             -> external.method (外部) ✓
```

## 📚 完整工具套件

现在javaparsedemo项目包含**4个强大的分析器**：

| 工具 | 功能 | 运行命令 |
|------|------|----------|
| **SecurityAnalyzer** | 检测6类安全漏洞 | `SecurityAnalyzer` |
| **MethodCallChainAnalyzer** | 分析调用链关系 | `MethodCallChainAnalyzer` |
| **ASTVisualizer** | AST可视化 | `ASTVisualizer` |
| **MethodAnalyzer** | 复杂度分析 | `MethodAnalyzer` |

### 配合使用最佳实践

```bash
# 1. 安全扫描
mvn exec:java -Dexec.mainClass="com.security.analyzer.SecurityAnalyzer"
# 输出: 发现getOrderById有IDOR漏洞

# 2. 调用链分析
mvn exec:java -Dexec.mainClass="com.security.analyzer.MethodCallChainAnalyzer"
# 输入: getOrderById
# 输出: 找到3个上游调用者，需要全部加授权

# 3. 复杂度分析
mvn exec:java -Dexec.mainClass="com.security.analyzer.MethodAnalyzer"
# 输出: getOrderById复杂度为2，修复工作量不大
```

## 📖 文档导航

| 文档 | 说明 |
|------|------|
| **方法调用链分析器说明.md** | 本文档 - 快速概览 |
| **CALLCHAIN_README.md** | 功能详细介绍 |
| **CALLCHAIN_USAGE.md** | 完整使用指南和教程 |
| **START_HERE.md** | 整个项目的入门指南 |
| **README.md** | 项目总览 |

## ⚙️ 系统要求

- Java 8+
- Maven 3.6+
- 已编译的项目

## 🎓 学习建议

### 初级用户
1. 运行 `./run-callchain.sh` 查看Demo
2. 阅读输出理解功能
3. 查看 CALLCHAIN_README.md

### 中级用户
4. 使用交互式版本查询方法
5. 尝试不同的查询选项
6. 阅读 CALLCHAIN_USAGE.md

### 高级用户
7. 结合其他分析器使用
8. 分析实际项目
9. 查看源代码理解实现

## 🌟 特色亮点

- ✅ **递归穿透** - 不止直接调用，包括所有间接调用
- ✅ **双向查询** - 同时支持上游和下游分析
- ✅ **交互式** - 支持实时查询任意方法
- ✅ **可视化** - 清晰的树形结构展示
- ✅ **实用性强** - 真正解决实际问题

## ⚠️ 注意事项

1. **外部方法** - JDK和第三方库标记为"外部方法"
2. **简单解析** - 基于名称匹配，不做完整类型推断  
3. **递归限制** - 最大深度10层
4. **接口调用** - 可能无法解析到具体实现
5. **反射调用** - 无法识别

## 💪 项目成就

### 原有功能（3个分析器）
✅ 安全漏洞检测（6类漏洞）  
✅ AST可视化  
✅ 方法复杂度分析  

### 新增功能（第4个分析器）
✅ **方法调用链分析**（上游+下游+递归穿透）  
✅ 交互式查询界面  
✅ 自动演示Demo  
✅ 完整使用文档  
✅ 快速启动脚本  

## 🎉 总结

方法调用链分析器是一个**简单但强大**的工具：

- **简单**：一键运行，交互式查询
- **强大**：递归穿透，找出所有间接调用
- **实用**：追踪漏洞、评估影响、理解代码

配合Security Analyzer使用，可以：
1. 发现安全漏洞
2. 追踪影响范围
3. 评估修复工作量
4. 确保全面修复

---

**立即开始**：
```bash
cd javaparsedemo
./run-callchain.sh
```

**查看详细文档**：
```bash
cat CALLCHAIN_USAGE.md
```

祝使用愉快！🚀

