大模型识别安全越权问题方法调研
一、概述

1.1 越权问题定义
水平越权： 同一权限级别的用户之间，用户A能够访问或操作用户B的资源。例如北京辖区的监管员访问福建辖区的数据。
垂直越权： 低权限用户能够访问或执行高权限用户的操作。例如证监局调用上市司管理接口。
1.2 方案概述
首先，通过 JavaParser 对 MR 分支的完整代码进行全量静态解析，提取 @tdAuthDesc 等权限声明，构建出一个包含完整调用链和全局配置的代码上下文。
其次，大模型结合知识库进行智能分析，通过比对"应有权限"（来自注解或推断）与"实际代码"，识别辖区权限缺失、角色绕过等安全问题。
最后，系统将检测结果自动评论到 MR，提供清晰的漏洞描述和修复建议，实现高效的安全测试闭环。

二、总体方案

2.1 整体流程
第一步：触发安全检测
当 MR 提交包含以下变更时，自动触发安全检测：
新增或修改 @GetMapping、@PostMapping 等 Controller 接口
修改 Service 层中包含权限校验逻辑（如 if 判断）的方法
修改 DAO 层中涉及数据权限过滤的方法
修改 HandlerInterceptor 拦截器或 Filter 过滤器（当前代码此类情况较少）
修改 AOP 切面（@Aspect）权限定义（当前代码此类情况较少）
网关层的路由控制
第二步：解析代码并构建上下文
对 MR 分支的完整代码使用 JavaParser 及其配套工具进行全量解析，以构建一个包含所有变更及相关代码的 AST，从而提取并结构化以下信息：
变更的接口与方法： 识别所有变更的 Controller 接口（如 @GetMapping、@PostMapping）及其 URL 路径和其他代码变更情况
权限声明： 提取方法上的 Javadoc 注释，特别是 @tdAuthDesc 标签的内容
完整调用链： 识别从网关、拦截器、外部调用（如公模），到 Controller、Service 层、Mapper 层的完整方法调用路径
第三步：大模型分析
结合知识库，使用大模型分析第二步提取的代码信息是否存在越权问题。
提取权限要求： 优先从 @tdAuthDesc 注解获取权限声明；如无注释，则从知识库中检索相似的业务权限规则、越权案例和修复代码模板
大模型分析判断：
o一致性检查： 判断权限声明（如 @tdAuthDesc）与代码实现是否一致
o水平越权检测： 检查是否存在辖区权限缺失、权限校验遗漏和不当等问题
o垂直越权检测： 检查是否存在角色权限绕过、状态限制（如审核状态）校验缺失等问题
o特殊场景检测： 待办等外部调用的权限是否符合现有规则
产出分析结论： 输出漏洞类型、风险等级和关键代码证据
第四步：输出结果
生成结构化的漏洞报告（JSON 格式）
提供具体的修复建议和修复代码示例
将报告自动评论到 MR（Markdown 格式），清晰展示漏洞详情

2.2 知识库建设
2.2.1 权限规则库
梳理并维护业务权限模型，包括：
角色定义： 从代码常量/枚举类提取角色及权限级别
辖区定义： 辖区编码、属性关系
数据权限范围： 基础信息（无权限）、敏感信息（涉及权限）
通用规则： 业务操作的通用权限校验规则
公共模块规则：
o待办：列表自动过滤，办理操作需要二次校验辖区等

2.2.2 越权案例库
维护历史越权案例及修复模板：
水平越权案例： 跨辖区访问、详情页未校验等
垂直越权案例： 角色权限绕过、状态校验缺失等
修复代码模板： 辖区校验、数据过滤等

三、技术实现要点

3.1 代码解析技术
使用 JavaParser 进行 AST 解析，提取方法签名、注解、调用关系等关键信息，全量代码解析可能有性能问题。
3.2 知识库内容建设
需要结合业务进行梳理
3.3 知识库API调用
通义灵码知识库API调用属于首次使用，可能存在未知风险。

四、预期效果与后续演进
预期效果：一是以自动化流程缩减人工安全测试成本，二是将持续积累的越权案例与修复模板沉淀为可复用的安全知识。
后续可考虑：一是多源信息融合（结合接口设计文档 Swagger/OpenAPI 与需求文档 PRD 等）不断提升判断的业务完备性与一致性；二是可通过大模型生成API越权测试用例，实现代码分析和API验证的双保险，三是在工程侧以增量更新机制与智能触发策略优化全量解析可能引发的性能问题，复用未变更模块的既有解析结果




安全扫描工具strix初步验证报告
定位与能力：Strix 是一款基于大语言模型的自主渗透测试 Agent 系统，既能对白盒代码仓库进行静态+动态分析，也能对运行中的 API / Web 目标开展黑盒测试，实现“理解业务→推演攻击→自动化验证”的全链路。
执行流程细化： 
a.代码与环境理解：解析仓库结构、路由、依赖与权限注解，构建调用链上下文；黑盒场景下则先做子域/端口/技术栈侦察。 
b.漏洞假设生成：借助越权、SQL注入等 Prompt 模块，多智能体协作并行制定测试策略，生成测试用例。 
c.自动化验证：通过浏览器、HTTP 代理、Python runtime 等工具在 Docker 沙箱内实施请求，区分不同身份与通道，确认是否真实越权或绕权。 
d.结果输出汇总证据，生成结构化报告和 Markdown 摘要
四层架构复述： 
┌─────────────────────────────────────────┐
│ 用户层：CLI / TUI 交互      │
├─────────────────────────────────────────┤
│ 智能层：StrixAgent + 多智能体协作体系        │
├─────────────────────────────────────────┤
│ 工具层：12 类渗透工具（Browser/Proxy/Terminal…） │
├─────────────────────────────────────────┤
│ 运行时层：Docker 沙箱隔离 + Token 验证通信      │
└─────────────────────────────────────────┘

越权相关：Strix 已经内置了针对越权访问的 Prompt 模块（idor.jinja）。它会指导智能体先梳理“哪个身份可以访问什么对象/操作”的越权矩阵，再按照业内通行的越权判定标准去编排测试步骤和验证要点，帮助确认是真实的横向或纵向越权，而不是误报。
已知限制： 
o部署需求时间
o强依赖所选 LLM 的推理与上下文能力，模型较弱时越权场景可能漏检。 Token 消耗高。 
o多 Agent 长迭代导致运行时长较大
o框架仍在快速演进，部分功能存在稳定性问题或边缘 bug。 
o黑盒验证需合法凭证与测试数据支持
验证用例：





